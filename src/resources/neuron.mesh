#version 460
#extension GL_EXT_mesh_shader: enable

layout (local_size_x = 1, local_size_y = 1, local_size_z = 1) in;
layout (lines) out;
layout (max_vertices = 2, max_primitives = 1) out;

layout (set = 0, binding = 0) uniform Matrices {
    mat4 view;
    mat4 viewProjection;
    mat4 inverseProjection;
    float near;
    float far;
};

struct Section {
    vec4 endAndRadius;
    uint type;
    uint parent;
};

layout(std430, set = 2, binding = 0) buffer Data {
    Section sections[];
};

struct TaskData {
    uint section;
};

taskPayloadSharedEXT TaskData td;

void pushVertex(uint i, vec4 position) {
    gl_MeshVerticesEXT[i].gl_Position = viewProjection * position;
}

void main() {
    Section section = sections[td.section];
    Section parent = sections[section.parent];

    vec3 end = section.endAndRadius.xyz;
    vec3 start = parent.endAndRadius.xyz;

    SetMeshOutputsEXT(2, 1);

    pushVertex(0, vec4(start, 1));
    pushVertex(1, vec4(end, 1));
    gl_PrimitiveLineIndicesEXT[0] = uvec2(0, 1);
}
    